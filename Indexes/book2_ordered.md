| slide title | description | Page |
| --- | --- | --- |
| Threats and Red Team Scenario – Routers |  Scanning; Fingerprinting (passive); DOS attack; Remote Code Execution; IP spoofing; IP source routing; ICMP flooding; Unauthorized tunneling; Routing table poisoning | 2.5 | 
| Routing Protocols | Routing protocols are designed to:  Automatically learn a network topology, including redundant pathsoChoose the optimal route that offers the best bandwidth and lowest latency; Attempt to automatically and quickly route around network outages<br> There are two basic types of routing protocols: Interior Gateway Protocols(IGPs) and Exterior Gateway Protocols (EGPs). IGP Examples: OSPF, EIGRP, IS-IS; EGP: BGP<br>IPv6, has routing protocols adapted from IPv4 or developed specifically for it, like RIPng (RIP next generation), an adaptation of RIP for IPv6, andOSPFv3, an evolution of OSPF for IPv6 support | 2.8 |
| Unauthorized Routing Updates | Routing protocols were designed with too much ‘implicit’ trust. Neighbor authentication should be in place to avoid unauthorized routing updates; Without neighbor authentication, a properly positioned attacker could inject bogus routes; This would make Machine-in-the-Middle (MitM) attacks easy to accomplish. <br> Routing protocols support plaintext or key (hash) authentication (BGP and EIGRP only allow hashed); Plaintext should be avoided (the key may be sniffed and reused); MD5 is available across most equipment but should be avoided in favor of HMAC-SHA-256 or HMAC-SHA-512 where supported (see DISA STIG reference below). BGP is excluded since it can only support MD5 by design. <br> Organizations managing their own Autonomous Systems (AS) should mitigate BGP prefix hijacks with Resource Public Key Infrastructure (RPKI – see notes). NIST live RPKI monitor2shows ~45% IPv4 prefixes comply with RPKI in 2023. | 2.9 | 
| Wormhole Attack | A wormhole attack describes an unauthorized tunnel, typically configured to and from an internal router; The attack requires unauthorized access to a router; This allows a Machine-in-the-Middle attack on any packet that is routed by that router.<br> <br>Wormhole attacks may be used to tunnel traffic by individual ports, IP addresses, or networks | 2.11 | 
| Physical Access, Ports, and SSHd | Switches and routers should be placed in secure locations, such as locked network management closets<br> >AUX (typically used for modem connections) ports should be secured with passwords or disabled if only the console is used (typically used for connecting via a terminal emulator such as putty).<br> >TACACS+ allows access via SSH, HTTPS, telnet, or HTTP.<br> >Disable SSHv1 and force SSHv2. Never use telnet or any other plain text protocol.<br> >Cisco devices default to an RSA key size of 512 bits. Use a 2048- or 4096-bit key.<br> >Set 'ssh authentication-retries' to 3, to make the device drop the connection after three failed logins. | 2.15 | 
| Disable Unused Services and Legacy Protocols | Defensible networks offer a minimum number of services.1—RichardBejtlich<br>Routers and switches can run unnecessary (and often legacy) services suchas bootp and fingerd.oThe advice here is the same as in the UNIX, Linux, macOS, and Windows world: disableunnecessary services.<br>Disable the following on routers and switches (Cisco IOS syntax is in thenotes):obootp, fingerd, httpd, mop, and pad<br>Also, disable the following if not being used: CDP and SNMP  | 2.18 | 
| Enable Centralized Logging | Enable centralized logging on all relevant devices, including switches and routers. Send logs to a syslog server or SIEM.<br>In addition to being a best practice, Layer 2 mitigations described in this course can create logs when triggered.<br>To enable centralized logging on a Cisco switch (to a syslog server at 10.5.30.5): **Router(config)#logging 10.5.30.5** When supported, secure logging based on RFC5425 (TLS for Syslog) should be used. This adds authentication to client and server, encryption of the data and integrity verification. | 2.19 |
| Loopback Interface, Sw/Rtr | The loopback interface on a switch or router is used as adedicated in-band management IP address.oIn-band access is usually complemented with Out-Of-Band Management(OOB). Many vendors provide a separate management VRF, withseparate routing tables for management purposes.<br>Switch and router loopback interfaces are beneficial becausethese devices often have multipleinterfaces with IP addresses.<br>Assume an 8-interface router without a loopback interface:oIt could theoretically be managed via SSH through any of the interfaces.oACLs for controlling traffic from the router (such as syslog) can bechallenging to write since any of the eight interfaces could be the source. | 2.20 | 
| Secure Passwords, sw/rtr | Cisco recommends the use of individual local accounts for fallback purposes; Cisco devices support a variety of password types, with strengths rangingfrom none (plaintext) to poor (Type 7) to reasonable to strong.<br>The default password type is Type 0 (plaintext).  *Switch(config)# username user0 password Security530* Here is the resulting Cisco IOS configuration entry:username user0 password 0 Security530....**Do not use Type 7 passwords (Vigenère Cipher)** *they are extremely weak*.  In order of preference, use Type 9 (SCRYPT), Type 8 (PBKDF2), or Type 5(salted MD5) | 2.22 |
| Cisco Type 5, 8, and 9 Password Hashes | Cisco supports the following password hashes that offer more security <br>Fair: Type 5 (Salted MD5)oBetter: Type 8 (PBKDF2 –SHA256)oBest: Type 9 (SCRYPT)<br>Type 8 (PBKDF2-SHA256) and Type 9 (SCRYPT) password hashes were added to Cisco IOS 15 as of version 15.3(3)M3 (released in 2014) <br>They are relatively new, and many organizations are unaware of them; Most sites use Type 5 (MD5), which is better than Types 0 or 7, but fairly weak today. <br> **Do not use Type 4; it is weaker than Type 5** Type 4 uses one round of SHA256 with no salt.1oThis option has been removed from recent versions of Cisco IOS. | 2.23 |
| Slow Encryption | There are two basic uses for hashes in information security with differing needs <br> Hashing for integrity should be cryptographically strong and computationally inexpensive(fast) <br> Hashing for passwords should be cryptographically strong andcomputationally expensive(slow).<br>Both PBKDF2-HMAC-SHA256 (Type 8) and SCRYPT (Type 9)are cryptographically strong <br> PBKDF2 is slow, while SCRYPT is even slower; Either is reasonable, and Type 9 is preferred | 2.24 | 
| Banners | Cisco switches and routers support the followingbanners: **Login** (shown before all logins); **Exec** (shown after all logins); **MotD** (Message of the Day, shown before all logins except SSH,where it is shown after)<br>The login banner is the most critical, since it displays thebanner text before authentication is attempted. Cisco devices support narrower-use banners, including incoming (used with reverse telnet sessions) and slip-ppp banner (used with SLIP and PPP connections).| 2.26 | 
| Cisco Smart Install |  a plug-and-play configuration and image-management feature that provides zero-touch deployment for new switches. You can ship a switch to a location, place it in the network and power it on with no configuration required on the device. CVE-2018-0171 (released March 28, 2018) describes a remote code execution flaw in Smart Install. Smart Install protocol does not require authentication.  Patching mitigates CVE-2018-0171 , but not the authentication flaw.  <br>Filter TCP port 4786 and/or disable Smart Install. *Switch(config)# no vstack* <br> Metasploit: *nmap -p 4786 -v <IP Address(s)> use auxiliary/scanner/misc/cisco_smart_install* | 2.27 |
| Cisco Sigma Analytics | Cisco accounting command logs can be used to detect malicious and unauthorized activity.<br>This is usually accomplished by deploying TACACS+ Server and enabling AAA new-model.<br>Sigma (covered in 530.5) has detection analytics mapped to MITRE ATT&CK in their GitHub | 2.29 | 
| Cisco Best Practices | Cisco produces lots of high-quality documentation for securing their devices; Also loads of great third-party sites, blogs, etc.; <br>The best one-stop shopping guide for securing Cisco switches and routers is the “Cisco Guide to Harden Cisco IOS Devices.”; It is concise and actionable. It also covers switches and routers in equal depth. Many hardening guides (such as CIS) cover routers in detail, but not switches. | 2.31 | 
| Cisco AutoSecure | Cisco's AutoSecure automatically configures a switch or router for a variety of best practices, uses single cli command to disable vuln ip services, enable defensive focused IP svcs, and simply and harden security configuration | 2.32-33 | 
| DISA STIGs<br> | DISA produces the Secure Technical Implementation Guides(STIGs).oThey are freely available and exhaustive in their coverage.<br>U.S. government and military personnel are usually quitefamiliar with the STIGs, but many private sector companies areunaware of them (and therefore don't use them).<br>Their guidance on switches and routers (and other devices) isconcise, direct, and actionable. | 2.34 |
| Cisco Layer 2 Benchmarks: DISA STIG High Severity | The network device must require authentication for console access.<br>The switch must be configured to use 802.1x authentication on host facing access switch ports.1<br>Group accounts must not be configured for use on the network device.<br>The emergency administration account must be set to an appropriate authorization level to perform necessary administrative functions when the authentication server is not online.<br>Network devices must be password protected.| 2.35 |
| Cisco Layer 2 Benchmarks: DISA STIG High Severity II | Network devices must not have any default manufacturer passwords.<br>The network element must be configured to ensure passwords are notviewable when displaying configuration information.<br>The network device must not use the default or well-known SNMPcommunity strings public and private.<br>The network devices must require authentication prior to establishing amanagement connection for administrative access.<br>The network device must use SNMP Version 3 Security Model with FIPS140-2 validated cryptography for any SNMP agent configured on thedevice. | 2.36 | 
| Layer 3 Benchmarks, CIS | CIS offers a broad range of security benchmarks:oSwitches, routers, and firewalls, including Palo Alto, Checkpoint, Juniper and Fortinet, F5 and pfSenseFirewall.<br>Router benchmarks include:oCisco IOS 12, IOS 15, IOS 16, IOS 17<br>Benchmarks are broken up into sections and categorized as Level 1 or Level 2 oManagement, Control and Data plane<br>Additional benchmarks are offered by vendors, DISA (Defense Information Systems Agency) STIGs (Security Technical Implementation Guide), and others.<br>Most switch benchmarks cover both routing and switching. | 2.37 |
| CIS Level 1 and Level 2 Benchmarks | Level 1 - Items in this profile intend to:oBe practical and prudentoProvide a clear security benefit; andoDo not inhibit the utility of the technology beyond acceptable means <br> <br>Level 2 - This profile extends the "Level 1" profile. Items in this profile exhibit one or more of the following characteristics:oAre intended for environments or use cases where security is paramountoActs as a defense in-depth measure.oMay negatively inhibit the utility or performance of the technology. <br> <br>Organizations should strive to complete all Level 1 benchmarks and complete as many Level 2 as beneficial. | 2.39 |
| Layer 3 Auditing Tools | CIS's (free) Router Audit Tool is now end-of-life. Replaced by CIS-CAT Pro; $1,400/year for orgs w/ less than 50 employees. <br> Nipper (formerly CiscoParse, now part of Titania) has split intotwo versions: Nipper and Nipper Enterprise (commercial) andnipper-ng (open source).oNipper can assess commercial routers and firewalls, comparing thecurrent configuration of a device to a known good configuration based onDISA STIGs, NIST, and other standards.onipper-ng code is available at: https://github.com/arpitn30/nipper-ng40 | 2.40 | 
| Auditing Tool Pro Tip | Audit your switches and routers before beginning remediation.<br>A course author began applying the Cisco CIS Benchmarks to a large enterprise with 400+ routers.oGoal: apply all CIS Level 1 recommendations (and most Level 2).oHe generated CIS’s Router Audit Tool (RAT) two-thirds of the way through the project (average score was 73%).oThe goal was achieved with an average final score of 96%.<br>Lesson learned: run the tool before any changes are made, report the score to management, and then report weekly progress.oOtherwise, management may not appreciate (or fund) the work required to get to 96%.oThat's a risk of silently solving difficult problems! | 2.43 | 
|  SNMP, Securing | SNMP can represent a significant security vulnerability. <br>All versions prior to SNMPv3 expose the plaintext community string on the network.oSNMPv2c is the most commonly deployed version of SNMP.<br>SNMP Read community string: allows read access to the SNMP-enabled device<br>SNMP Write community string: allows read-write access (meaning the ability to change) SNMP-enabled deviceoAlso allows downloading the complete IOS configuration on Cisco routers and switches | 2.47 | 
| SNMP Attack Guess the Community Strings | The Metasploit penetration testing framework includes a number of SNMP modules.<br>We used the *snmp_logon auxiliary module* to guess the SNMP RWcommunity string.oThis module includes a wordlist of 120 common SNMP community strings.<br>The SNMP RW community string for this router is "xyzzy." | 2.48 | 
| SNMP Attack: Download the Cisco IOS Configuration | Access to the SNMP read/write string on a Cisco switch or router allows downloading the Cisco IOS configuration, including any passwords and/or password hashes. | 2.49 | 
| Passwords Exposed via SNMP Attack | The Cisco IOS configuration downloaded via SNMP containedType 0 (plaintext) and Type 5 (salted MD5 hashes)| 2.50 |
| Hardening SNMP | Disable SNMP if not required<br>If SNMP is required:oDisable SNMP write access if possible.oUse complex (or randomly generated) community strings.oUse SNMP version 3 on all supported equipment.oFor non SNMPv3-capable devices that require SNMP, use SNMP version 2c with access lists that restrict polling to required servers only (such as network management and/or monitoring systems).oEnable logging to record commands executed on your network devices, such as TACACS+ and Syslog. Use these logs to immediately highlight suspicious events | 2.51 | 
| Securing NTP | Clock skew can create considerable issues. Especially during incident handling and forensic investigationsoAuthentication frameworks, including Kerberos, can be affected by serious clock skew.<br>NTP (Network Time Protocol) is used to set clocks on networked computers.oIt uses UDP port 123.<br>SNTP (Simple Network Time Protocol) is sometimes used.oThe same basic protocol as NTP, but with much of the complexity removed and lessaccurate than NTP. Windows 2000 and XP's Windows Time service (W32Time) usedSNTP.oNewer versions of Windows use NTP (RFC 1305) or MS-NTP to synchronize the localsystem time to an NTP and/or MS-NTP compliant reference server. The other is forHyper-V and synchronizes virtual machines (VM) to the Hyper-V host. | 2.54 |
| NTP Authentication | NTP is sent over UDP, which may be spoofed.oIt can also be vulnerable to Machine-in-the-Middle attacks.<br>NTP supports authentication. oThe public pool.ntp.org web servers do not use authentication.<br>NIST provides free public authenticated NTP service.oRequires registration by snail mail or fax(!)oSee notes for details.<br>Another option: purchasing stratum one-time servers, and syncing to them locally<br>The device shown below is a stratum 1 NTP server, available for under $300 US. | 2.57 | 
| NTP Amplification Attacks | UDP-based services can sometimes be used for spoofed denial-of-service (DoS) attacks <br>NTP supports a 'monlist' command, which will return the client IP addresses that have synced most recently. Up to 600 addresses can be sent.<br>The attacker can then send a spoofed NTP *‘monlist’* command to a vulnerable server.oIn a recent test by Cloudflare,1one spoofed234-byte UDP packet resulted in 100response packets, totaling 48,000 bytes. o Resulting in an amplification factor of 206x | 2.57 | 
| Bogon and Fullbogons Filtering | Bogons are network blocks that should not be routed on the internet.oIncludes RFC1918 address, unallocated addresses by IANA, and othersoThese addresses are often used in DDoS attacks.oThe current list is in the notes.<br>For many years, Team Cymru has published the updated list in various formats.<br>With the continued depletion of IPv4 space and the continuing growth of IPv6, something more granular was required.<br>Fullbogonsadd the IP space allocated to the RIRs, but not yet assigned by them to ISPs or other end users.<br>Fullbogons are available for both IPv4 and IPv6 (larger feed) and change every day! | 2.61 | 
| Where to Configure a Bogon Filter | Most organizations configure the bogon filter in their outermost external router, dropping inbound traffic sent from the internet with a bogon source addresses.oThe external firewall may also be used.oIt's a simpler routing decision since it uses the IP address only, but either routers or firewalls may be used.<br>Also, consider dropping spoofed traffic from the internet with source IP address using company's internal addresses.<br>Team Cymru makes templates available for a variety of devices; see notes for details. The bogon list is updated periodically, so add calendar reminders to check for list updates. <br>Also consider Open Dynamic Block Lists or EDLs from https://opendbl.net/ | 2.63 | 
| Cisco IOS Bogon Filter Configuration | The complete list of bogons is shown on the previous "Bogon Filtering slide" and is also available from Team Cymru, **view on slide** | 2.64 | 
| Blackholes and Darknets | "darknet" originally referred to unused/non-routed IP addresses owned by an organization; The term "darknet" has been co-opted lately by "dark web" concepts, suchas TOR hidden nodes.oWe will use the term "IP darknet" to distinguish the two.<br>A blackhole route is used to drop traffic sent to specific IPaddresses.oUsually routed to the 'null0' interface (like /dev/null for a router)<br>Blackholes and darknets are related; the difference is darknetsare routed to a darknet router, where the traffic is analyzed.| 2.66|
| What Kind of Traffic Is Sent to an IP Darknet? | All traffic sent to a darknet is bogus, by definitionoThere are two types of darknet traffic sources: misconfigured and/ormalicious traffic.oIP darknet monitoring can offer critical insights into misconfiguredand/or malicious traffic on a network.<br>Team Cymru's IP Darknet monitor discovered the Witty worm | 2.68 | 
| IP Darknet Architecture | Route all IP darknet traffic to a dedicated darknet router.oMonitor this traffic via SNMP.<br>That router forwards traffic to a “packet vacuum” sensor.oThis sensor sniffs and drops the traffic. | 2.69 | 
| Threats and Red Team Scenario – IPv6 | Neighbor Advertisement Spoofing<br>SLAAC attack<br>Fake DHCPv6<br>Other vulnerabilities in IPv6<br>Blindness of IPv6 traffic of IDS/IPS<br>Tunneling | 2.75 | 
| IPv4: Nearly Exhausted | IPv4 allows 4.2+ billion addresses, which probably seemed like a lot in 1982when TCP was initially released.<br>All of the major publicly routable IPv4 netblocks have been issued.oIf you want IPv4 address blocks in most areas of the world, you must pay for them or goon a waiting list.oRecent IPv4 prices (per IP address in $USD)1:<br>IPv6 is growing very quickly (as we will show shortly) as a result. | 2.76 | 
| IPv6: Growing Fast | IPv6 traffic continues to grow quickly, now making up over 40% of internet backbone traffic.oThe graph on the right is from Google's IPv6 statistics page (Sept. 2023).<br>Many companies are ignoring IPv6, while currently using it.oThis is a mistake.<br>Microsoft recommends not to disable IPv6 | 2.77 | 
| IPv4 and IPv6 | IPv4 addresses are 32 bits long.<br>4.2+ billion possible addresses....IPv6 addresses are 128 bits long.<br>340 undecillion addresses (340^36) IPv6 offers massively larger address space.<br>Also, cleaner routing<br>Flexible embedded protocol support<br>Stateless autoconfiguration | 2.78 |  
| IPv6 Header and Header Fields | **Version (4 bits)** - Set to 6 - IPv4 uses 4 <br>**Traffic Class (8 bits)** - Sets the priority of the packet <br>**Flow Label (20 bits)** - used to associate multiple packets in the same stream, such as a video transfer <br>**Payload Length (16 bits)** - length (in bytes) of the payload <br>**Next Header (8 bits)** - describes the IPv6 extension header (if used) or the Layer 4 header (TCP, UDP, etc.) <br>**Hop Limit (8 bits)** - renamed from IPv4's "Time to Live" field <br>**Source and Destination IP addresses (128 bits)** | 2.79 | 
| IPv6 Extension Headers | First header is always 40 bytes long.  Headers have one fixed header *and zero or more optional (extension) headers*. **Every extension header is 8 bytes long** which may be used for options like routing, fragmentation, authentication, encapsulation, Ect. <br> Multiple extension headers may be used in one packet, chained together, with no chain limit; Can lead to interesting attacks, including denial of service; Many use ACLs to drop packets containing extension headers | 2.81 |
| IPv6 Addresses | colon-separated hexadecimal values;  Repeated zeros may be summarized as “::”.Address below is:<br>fe80:0000:0000:0000:020c:29ff:fec0:f094 <br>Summarized to: fe80::20c:29ff:fec0:f094 | 2.84 | 
| IPv6 Subnet Size | Default subnet size is a /64. /64 is 18+ quintillion addresses. 18^36 | 1.85 | 
| Types of IPv6 Addresses | IPv6 systems may use three separate address types: <br> **Link-local addresses** (similar to 169.254.0.0/16 in IPv4); Used on the local subnet only, addresses begin with "fe8, fe9, fea, or feb" or "has anetwork prefix offe80::/10."oAll IPv6-enabled systems have this address. <br> **Unique local addresses** (ULA); May be used on privately owned networks, addresses begin with "fd" (network prefix fd00::/8); They are not routed publicly.oSome organizations do not use these addresses; <br> **Global unicast addresses**: Routed publicly; Systems may have multiple unique local and global unicast addresses. | 2.86 | 
| IPv6 Address Format | IPv6 global unicast addresses1allow 65,536 subnets (16 bits), each with 18+ quintillion host addresses (64 bits):<br>Unique local addresses2include a 40-bit Global ID, which is designed to be generated randomly (as we will discuss next). They also allow 65,536 subnets (16 bits), each with 18+ quintillion host addresses (64 bits) | 2.87 | 
| Determining IPv6 Network Allocations | Global unicast address allocations are issued to organizations by RegionalInternet Registries, such as ARIN, RIPE, AFRINIC, APNIC, and LACNIC.<br>Unique local addresses are used locally but are designed to be globallyunique.oThis avoids requiring renumbering subnets if two organizations connect unique localaddress subnets via an extranet connection.<br>Unique local address Global IDs are generated randomly.o40 bits of the address are set randomly.oThere are 1.1 trillion possible subnets.oThe odds of a collision between two organizations is quite small.8 | 2.88 | 
| IPv6 Stateless Address Auto Configuration | SLAAC originally used the MAC address to form an IPv6 address (privacy issues re). <br> The system listens for IPv6 global prefix router advertisement: Link-local prefix **“0xfe80”** is used for the link-local address. <br> 48-bit MAC address is split in half; Constant “0xfffe” inserted in the middle <br> The 7th bit of MAC address is flipped for universal addresses <br> Note that static or DHCPv6-assigned addresses may also be used. | 2.89 |
| Effect of Temporary IPv6 Addresses | In Windows, macOS, and most Linux distributions, the default IPv6 preferred lifetime is 1 day, and the** default valid lifetime is 7 days**. This value can be overridden by IPv6 route advertisements (see notes). <br> The screenshots on the right show in slide shows the same system, 24 hours apart.<br> IPv4-style thinking often fails with IPv6.oManually filtering or blocking temporary IPv6 addresses is not effective.<br>Note that privacy-enhanced IPv6 addresses are used when systems use SLAAC to generate an IP address. They are not used when the IPv6 address is assigned via DHCPv6 or other methods. | 2.93 | 
| There’s No Place Like ::1 | ::1 is the equivalent of the IPv4 address 127.0.0.1. <br> fc00::/7 is reserved for unique local addresses.oEquivalent to IPv4 RFC1918 addresses (such as 192.168.0.0/16, 10.0.0.0/8, etc.)1ofc00::/7 is further divided into two /8 subnets: fc00::/8 and fd00::/8; While reserved, usage of fc00::/8 is not yet defined.oSites usefd00::/8 to assign unique local addresses. | 2.95 | 
| IPv6 Multicast Addresses | IPv6 does not support broadcast addresses and uses multicastaddresses to perform a similar function to IPv4's broadcastaddresses.oBroadcast addresses are used for one -> all communication.oMulticast addresses are used for one -> many communication.<br> IPv6 uses the ff00::/8 network prefix for multicast addresses.<br> Two important IPv6 multicast addresses (more listed in thenotes):off02::1 - All local nodes (cannot be routed)off02::2 - All local routers (cannot be routed)| 2.96 |
| Assigning IPv6 Addresses | There are a number of methods for assigning IPv6 addresses: Static AssignmentoStateless Address Auto Configuration (SLAAC)<: Assigns the IPv6 host address statelessly and assigns the network prefix for global unicast and unique local addresses from a Router Advertisement (RA) daemon (if available)<br>As noted previously, modern systems use IPv6 Privacy Extension addresses to create the unique local and global unicast addresses;  DHCPv6 – This is the preferred way to assign addresses in an Enterprise environment.<br>Stateful DHCPv6: similar to DHCP (v4), assigns all options (except the default gateway)<br>Stateless DHCPv6: RA daemon assigns an address (and gateway), DHCPv6 assigns other options (such as DNS settings, etc.) Unfortunately: DHCPv6 cannot assign the default gateway.<br>This means DHCPv6 must be used in conjunction with a router advertisement daemon. | 2.97 | 
| Securing IPv6  | NIST SP 800-119, "Guidelines for the Secure Deployment of IPv6," in 2010.<br> In June 2022, the US National Security Agency (NSA) published updated guidance.<br> They outline the following risks: Auto-configuration (SLAAC).oAutomatic tunnels (i.e. 6to4, Teredo, etc.) oVulnerabilities present in IPv6, including ― zero day vulnerabilities that are inherent in any new or revised system Complexity added by dual stack IPv4/IPv6 operationsoImmaturity of IPv6 security products and processes  Lack of IPv6 education | 2.100 |
| IPv6 Security Issues |Every organization with modern Operating Systems are using IPv6 right now.oMost are ignoring it.oMalware festers in the darkness.<br> Some firewalls may not be able to process IPv6 at all (or do it incorrectly). <br> Scanning IPv6 is challenging (and quite different than scanning IPv4).<br> IPv6 offers robust tunneling options that can evade filtering and detection.<br> Attackers with internal access can advertise IPv6 routes to internal systems. | 2.101 |
| IPv6 Firewall Support | Some firewalls cannot support IPv6 or rely on a separate firewall to do so. <br> - For example, the Linux iptables firewall does not support IPv6, but ip6tables(included with iptables) does.oThis means two independent firewalls must run on the same host in order to filter bothIPv4 and IPv6; A host running iptables only (including a final DROP rule, see notes for details) will notfilter any IPv6 traffic. <br> - Nftables (iptables’ successor) supports IPv4/IPv6 aware tables. Using asingle “inet” table it's possible to add only one rule to match both protocols. <br> - Firewalls that support IPv6 are often laxer than IPv4 firewalls.oSome IPv6 firewalls cannot block inbound ICMPv6. | 2.102 | 
| Scanning IPv6 | The process for actively scanning IPv6 networks for host discovery is fundamentally different than scanning IPv4 networks.<br> -IPv4-style end-to-end ping sweeps are not possible due to the size of thesubnets.oIf you could ping one host per second ...oIt would take 584 billion years to scan 18+ quintillion IPv6 addresses on a /64 network.<br> -IPv6 multicast address become critical for performing local host discoveryoSome older methods, such as switch CAM (Content Addressable Memory) inspectionand passive scanning, still work.o IPv6 does not use ARP (it uses neighbor discovery via multicast, as we will discuss next),but dual-stack systems may be discovered via ARP. | 2.104 |
| Native Operating System IPv6 Discovery Tools | Here are some of the Windows, Linux, and MacOS/BSD commands to perform IPv6 pings and to show the IPv6 NDP (Neighbor Discovery Protocol) and IPv6 route tables.1<br> -Nmap has several NSE (Nmap scripting engine) scripts for discovering IPv6.<br> -Metasploit can perform IPv6 multicast scans with the "ipv6_multicast_ping”, “ipv6_neighbor_router_advertisement” and “ipv6_neighbor” modules | 2.105 | 
| Other Ways of Discovering IPv6 Traffic | Zeek: Look for type AAAA queries in dns.log.<br> -Look for IPv6 addresses in conn.log (regex in notes).<br> -Firewall logs<br> -NetFlow data <br> -IDS rules<br> -ACLs: permit/deny ipv6 any any log<br> -SNMP MIBs | 2.107 | 
| IPv6 Tunneling Options | There are a wide variety of IPv6 tunneling options, including:; 6to4, 6in4 and 6over4; 6rd; 4 over 6; Teredo; ISATAP; GRE; The wide variety and types of IPv6 tunnels make both preventing and detecting them difficult. These tunnels can also be used to evade or bypass controls such as IDSes and IPSes | 2.109 | 
| Preventing and Detecting IPv6 Tunneling | Many forms of IPv6 via IPv4tunnels carry IPv6 where TCPor UDP would normally be.oThe Layer 3 header "Protocol"field would be 41 (IPv6) in thiscase.<br> -Configure Next-GenFirewalls, IDSes, and/or IPSs to block/alert protocol 41.  Snort syntax: *ip_proto:41* | 2.11O | 
| Preventing and Detecting Teredo Tunneling | <br> -Teredo was originally developed by Microsoft and is standardized in RFC 4380.1<br> -It uses UDP port 3544 by default, but other UDP ports may be used.<br> -The Wireshark display filter "teredo" will detect Teredo tunnels via any UDP port. See notes for the Snort rule. | 2.111 | 
| Unauthorized IPv6 Router Advertisements | In this scenario, an attacker compromises an internal client system via a phishing attack via IPv4. o The attacker then creates a 6to4 tunnel from the compromised client to the IPv6 Internet.oThe compromised client then sends IPv6 router advertisements to the local subnet, identifying the client PC as an IPv6 router.  The local systems create a global unicast address, using the network prefix assigned by the rogue IPv6 router.<br> -That local subnet is now directly exposed to the public IPv6 Internet.oWe will illustrate this attack on the next slide.<br> -Router Advertisement (RA) Guard mitigates this risk (see notes for details)oRA Guard also mitigates DoS via IPv6 Route Advertisement flooding. | 2.113 |
| Defending Against Rogue RA Attacks | Examine the “weapons”; notice artifacts created by Metasploit’s implementation of the attack (see screenshot).; Detect RA messages from two or more different sources.; Have all routers send their RA messages with ‘high priority’ (default is medium – see notes).; Host-based monitoring tools can detect rogue RA attacks, but best solution is to enable RA Guard | 2.115 | 
| Redesign and Implement on 530.2 – IPv6 | Follow NSA IPv6 Security Guidance.; Know IPv6 capabilities of your prevention and detection tools.; Configure NGFW, IDS, and IPS to block/alert on protocol 41.; Use Cisco IOS ACL to log protocol 41 and UDP port 3544.; Use Router Advertisement Guard to mitigate unauthorized IPv6 router advertisements along with DHCPv6 snooping.; Follow additional rules discussed on the notes.| 2.117 |
| Segmentation |  is often interpreted as network segmentation.<br> -Network segmentation involves separating networks<br> -And placing access controls between each network; Network segmentation is highly effective across hybrid environments (on-prem and cloud) at reducing the attacker’s ability to maneuver (lateral movement).<br> -But segmentation does not stop at the network.<br> -Segmentation needs to include authentication and access.<br> -It needs to be combined with application-awaredefenses | 2.122 |
| Network vs. Access Segmentation | **Network Controls**access based on: MAC, IP,Applicationo; **Access Controls** Limit access based on credentials: Device, User, MFA| 2.124 |
| Segmentation Principles | should facilitate prevention and detection. - Systems and data with different classification levels (tiers) must reside in different zones. <br>- Control points are implemented at **"gates,"** where all ingress and egress traffic is inspected, and access control policies enforced. <br>- Balance security with usability. <br>- Higher segmentation adds complexity and administrative burden. Insufficient segmentation can make the network indefensible. | 2.125 | 
| DMZ Design | The risk of a compromised DMZ system pivoting into internal systems (or other DMZ systems) must be mitigated. <br> Untrusted->DMZ access should be tightly filtered, plus DMZ->trusted <br> DMZs with multiple servers should be broken up into individual zones (or separate DMZs).<br> Private VLANs may also be used.; Promiscuous port: the firewall DMZ interface; Isolated ports: DMZ servers that only need to send traffic via the firewall; Community ports: when multiple DMZ systems need to communicate with each other (and via the firewall) | 2.128 | 
| Beyond DMZ  Segmentation is More Than 2 Zones| Security zones should be established according to: Business and regulation requirements; PCI DSS requires segmentation of systems processing credit card data.<br> Criticality of assets; Domain controllers should be segregated off user workstations.<br> Threats; Legacy systems should be segmented off.<br> Risk appetite; Wannacry, anyone? <br> The PERA or Purdue model reference architecture shown by CISA illustrate the level of effort needed, with yellow representing low effort and red representing high effort, for attackers to breach and navigate an  unsegmented network versus a highly segmented network.  | 2.130 | 
| Tiers – Based on Criticality and Business Impact | Tier 1:-Critical components to maintain operations, includingdomain controllers, exchange servers, and networkinfrastructure devices-Tier 2:-Internal systems containing PII and associated data,including databases, SharePoint servers, and other webservers-Tier 3:-External facing data-providing services | 2.132 | 
| Architecting with Security Operations Monitoring in Mind | Architecting using the concept of “zones” to defend your organization allows for both IT and business context to simplify building effective monitoring use cases.; A zone is a portion of your network with specific security requirements set.| 2.133 |
| Login Segmentation | The ability to access a system, process, or object should be limited to the principle of least privilege.; Plus, additional risk controls such as login segmentation; Example: IT needs access to manage workstations.; That does not mean a single user account should have full enterprise access.; Compensating controls should segment user access such as:; Jump boxes, secondary accounts, using local admin accounts with random passwords, administrative workstations | 2.135 | 
| Segmentation Summary | A form of risk reduction and should be a routine design and process.; Commonly associated with network designprincipals ; Applies to more concepts, such as loginsegmentationGoal is to lower damages and mitigate impact by limiting overall access, slowing down the attacker, and creating more opportunities for detection | 2.136 | 
| Application Layer Security | Layer 7 security refers to application layer security.; Means security based on full network protocol knowledge; And mainstream use of standard network protocols; Example: Microsoft Update uses HTTP (TCP/80) and HTTPS (TCP/443).1Use of application layer security differs by product and implementation.; Necessary to balance network and host protection | 2.139 | 
| Application Proxies | A proxy is a system that brokers traffic between systems.; Type of proxy is specific to the application; Example: HTTP, SMTP, SOCKS, FTPThe goal is to funnel traffic through a proxy, so it can:; Control the flow of data; Analyze traffic for unauthorized or malicious use; Cache contentDeployment and direction of proxy changes use | 2.14O |
| Proxy Types | ForwardSystems request access through a proxy to access a resource; Example: Web ProxyReverseService protected by forcing connections through a proxy; Example: Web Application Firewall/Load Balancer|2.141 | 
| Reverse Proxies, ZTNA and SASE | Reverse-proxies are central to the new network architectural strategies: Secure Access Service Edge (SASE) and Zero Trust Network Architecture (ZTNA).<br> - ZTNA is a product or service that creates an identity-and context-based, logical access boundary around applications, often used to replace VPN and secure multicloud access. <br> - SASE is an even newer approach that builds on ZTNA and that incorporates SD-WAN, Next Gen Firewall as a Service, Secure Web Gateways, and CASB/DLP, among others. <br> - Notice how endpoint agents will be needed in most cases. | 2.142 |
| Web Proxy | A web proxy acts as an intermediary for web access.; Primarily used to protect internal assets; Often underutilized and completely underestimated; Use of web proxy **forces analysis** of web traffic| 2.144 |
| Web Proxy Capabilities | Inspection of web traffic includes filtering based on:; Site category; URLs; File contents; Data loss prevention; MIME Types; User agents; Global reputation; Status codes; Cookies; Form values; Protocol anomalies; Certificates; AV signatures; Sandbox analysis | 2.145 |
| Site Categories | Web proxy often associated with site category filtering; Quick win for controlling access; Allows sites by categoryYou should block unknown sites.; Similar to default deny firewallNot a replacement for allow lists | 2.146 |
| Bypassing Site Categories | Domains often go up for auction.; Businesses close, or sites are no longer needed.Adversaries buy these and use them for phishing.; Great for buying pre-categorized sites | 2.147|
| Website Allow Lists | More secure approach than site cats is to createallow lists for all sites.; Requires gathering authorized sites and allowing them; Then denying anything else regardless of categoryThis involves more work  and maintenance.; One way to get started is to add every site accessed todayto an allow list.; May include evil inside but starts the allow listAllow listsprovide a significant security boon | 2.148 |
| Web Proxy Alternatives | Terms and Conditions and Authenticationcan be required either entirely or conditionally.; Malware highly likely to fail when against both of theseCould be required before internet access works; Some organizations require human interaction for web access.; Or could be applied to unknown or unauthed sites | 2.149 | 
| Proxy Deployment| Proxies are deployed in one of two modes:; Transparent– Traffic goes through proxy regardless of the endpoint configuration.; Explicit– Endpoints must be configured to use the proxy and firewalls configured to route all traffic through the proxy. ; Explicit works best when it is the only method to access the Internet, requiring all web access to funnel through the proxy. See blog from former SEC530 student on how to update firewalls with Zscaler service edge IPs and FQDNs. | 2.150 | 
| Explicit Proxy,  Advantages | Delegated DNS: -  In an explicit proxy setup, DNS query is performed by the proxy:  User types www.sec530.com/530.htm in the browser; If it matches an entry in the bypasslist, the clientusesits own DNS to resolve the name, and then client connects directly to the target IP addressand port<br> - GET /530.htm HTTP/1.1Host: www.sec530.comoIf no bypass list entries match, browser connects to its configured proxy, and sends a request with the full domain name <br> - GET http://www.sec530.com/530.htm HTTP/1.1;  The proxy resolves that host nameusing its own DNS and then connects to the target site.<br> - Clients can now resolve internal comms (i.e., AD) through an internal DNS server that doesn’t provide a forwarder to external resources, such as websites. All lookups for external websites are delegated to the proxy.| 2.152 |
| Authenticated vs. Unauthenticated Proxy | Malware is commonly not proxy aware, *but malware occasionally is aware*. **Explicit proxy plus authentication is the most secure** <br> ; Even proxy-aware malware struggles with credentials.; Malware would first have to steal credentials.; Then use them in a proxy-aware fashion for explicit mode. Unauthenticated proxies imply trust without verification.; Connect to a proxy, then device equals trusted = BAD | 2.153 | 
| Web Proxy Access Options | Internal proxy access, VPN access, Cloud Proxy Access, DMZ Proxy Access | 2.154 | 
| Squid | You do not need money to benefit from a web proxy.; Squid provides an open-source solution.Supports explicit and transparent configurations; Can use ClamAVfor antivirus checks; Or can integrate with ICAPservers; Supports web caching and acceleration; Supports SSL interceptionCommercial solutions are more robust.| 2.156 | 
| Internet Content Adaptation Protocol (ICAP) | ICAPis used to extend the capabilities of a proxy.; Offloads tasks to another system for processing; Typically includes antivirus and malware analysis; Often includes multiple antivirus enginesCustom integrations can be built using the ICAP service.; Recommend sticking with commercial solutions; ICAP requires advanced knowledge and programming.Squid uses ICAP to establish filtering with SquidGuard. | 2.157 | 
| Malware Detonation |  a great complement to web proxies.; Many SaaS vendors run sandboxes behind the ‘scenes’; The system usually is a virtualized system focused on behavioral detection that issues a verdict for binaries, scripts and URLs | 2.159 | 
| Maleare Detonation Workflow | High-level breakdown of how malware analysis works; File or URL is submitted; AV and reputation databases run checks (critical step).; If pass, then move on to sandbox analysis; If fail, block the file or connection; Run file or access URL using a virtual system or software; Behavioral activity looks normal= PASS; Behavioral activity looks abnormal=FAIL | 2.160 | 
| SMTP Proxy | Web and email traffic are common ways to enter a network.•Due to client-side phishing attacks•End users routinely use web and email, so the attack vector is massive.An SMTP proxy is an effective means to control email.•This is more commonly called a spam appliance.•Selling point is handling spam, but it does much moreSpam= NuisanceMalware= Compromise| 2.164 | 
| SMTP Prevention and Detection | Balancing security controls is difficult.<br>Focus on spam is pure prevention<br>More serious emails need prevention and detection.SMTP proxy capabilities include but not limited to:<br>Bayesian Analysis<br>Per email encryption<br>Handling phishing domains<br>Modifying and auto-routing emails<br>Sender authentication<br>Rate limiting<br>Sender blocking | 2.165 |
| Bayesian Analysis | Key prevention technique is learning ‘normal’ from email•Works with statistical probability•Not fancy machine learningWorks by checking words, emailheaders, and metadata•Ideally calculates per user•Changes over timeSpam/attackers can bypass this•Trial and error + read receipts | 2.166 | 
| Sender Policy Framework (SPF) | DNS record validates email sent from an authorized source•Based on authorized IP addresses•Based on DNS domain information (A record, MX record)•Can specify no email comes from a specific sub-domain•It protects the envelop sender address, not the address seen in the ‘From’ header (see notes)•We need to add an SPF record for every A record we have | 2.167 |
| Domain Keys Identified Mail (DKIM) | Uses digital signatures to validate email•Means asymmetric keys (private + public) and hashingKeys are created for each selector (may just need one).•Private key goes to email system(s)•Public key saved in DNS TXT record under _domainkey.domain.com | 2.169 | 
| Domain-Based Message Authentication, Reporting, and Compliance (DMARC) | DMARC verifies domain authentication via SPF or DKIM•Can use SPF/DKIM to force alignment of visible “From”DMARC policy dictates actions and protection level•Policy– Monitor, Quarantine, Reject•Alignment– Strict, Relaxed | 2.171 |
| Sender Authentication | Not all email systems support SPF, DKIM, or DMARC.; <br> Even when supported, enforcement variesProtection only applies to company-owned domains.; <br> No protection against cousin domain attackssec53O.comis a cousin domain of sec530.com.; <br> Blocking example.com from outside is great.; <br> Verifying all email sources of example.com is too.But how does one protect against sec53O.com | 2.172 |
| dnstwist / typosquatter | SMTP proxy can protect against cousin domains.; <br> You can add all possible domains into a proxy.; <br> Should configure to blockor quarantine and alert; <br> Requires identifying all possible domain permutationsdnstwist1and its new iteration, typosquatter2, calculates permutations against a given domain.; <br> Also checks to see if any domains have been registered; <br> And provides additional information about the domainUse dnstwist with scripting to handle deal with evil cousins | 2.173 | 
| Intentional Email Modification | SMTP proxies and email systems can add to a message.; <br> Disclaimer messages; <br> Custom headers or footer banners; <br> "This message came from an external source."; <br> "This message may be a phishing email acting as an executive."Requires setting up rules to do Xwhen Yis true; <br> If display name matches executive add phishing message; <br> If external source adds external source message | 2.174 |
| Combating Open-Source Intelligence | A good architect protects an organization.•A great architecture raises the bar against attackers.Try creating email accounts for users that do not exist.•Possibly register these accounts for online services.Any attempt to access or email these accounts = BAD•Scripting can automatically ban email senders.•Or at a minimum, spam appliance can generate an alert.| 2.175 | 